# 邮箱验证码系统配置说明

## 系统概述

本系统已成功集成了完整的邮箱验证码注册功能，包括：

### ✅ 已实现功能
- 📧 邮箱验证码发送
- 🔐 验证码验证
- 🛡️ 防刷机制（频率限制）
- 📱 前端验证码输入界面
- 🎨 美观的邮件模板
- 🔄 验证码重新发送
- ⏰ 倒计时功能
- 🗑️ 过期验证码自动清理

## 邮件服务配置

### 1. 环境变量配置

在项目根目录创建 `.env` 文件，或设置系统环境变量：

```bash
# 邮件服务器配置
MAIL_SERVER=smtp.qq.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USE_SSL=False

# 邮件账户信息
MAIL_USERNAME=your-email@qq.com
MAIL_PASSWORD=your-app-password

# 发件人信息
MAIL_DEFAULT_SENDER=your-email@qq.com

# 邮件发送限制
MAIL_MAX_EMAILS=100
MAIL_SUPPRESS_SEND=False
```

### 2. 常用邮件服务商配置

#### QQ邮箱配置
```bash
MAIL_SERVER=smtp.qq.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USE_SSL=False
MAIL_USERNAME=your-qq-email@qq.com
MAIL_PASSWORD=your-qq-app-password
```

#### 163邮箱配置
```bash
MAIL_SERVER=smtp.163.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USE_SSL=False
MAIL_USERNAME=your-email@163.com
MAIL_PASSWORD=your-163-app-password
```

#### Gmail配置
```bash
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USE_SSL=False
MAIL_USERNAME=your-gmail@gmail.com
MAIL_PASSWORD=your-gmail-app-password
```

### 3. 获取应用密码

#### QQ邮箱
1. 登录QQ邮箱
2. 设置 → 账户 → 开启SMTP服务
3. 生成授权码（16位字符）

#### 163邮箱
1. 登录163邮箱
2. 设置 → POP3/SMTP/IMAP
3. 开启SMTP服务
4. 设置客户端授权密码

#### Gmail
1. 登录Google账户
2. 安全设置 → 两步验证
3. 应用专用密码

## 系统特性

### 🔒 安全特性
- **频率限制**：每小时最多5次，每天最多20次
- **IP限制**：防止恶意刷验证码
- **验证码过期**：10分钟自动过期
- **一次性使用**：验证码使用后立即失效

### 📧 邮件模板
- **HTML格式**：美观的邮件模板
- **纯文本格式**：兼容性支持
- **多语言支持**：中文界面
- **品牌标识**：系统Logo和品牌信息

### 🎯 用户体验
- **实时验证**：邮箱格式实时检查
- **倒计时显示**：60秒倒计时
- **错误提示**：详细的错误信息
- **响应式设计**：移动端适配

## API接口

### 发送验证码
```http
POST /api/auth/send-verification-code
Content-Type: application/json

{
    "email": "user@example.com",
    "code_type": "register"
}
```

### 验证验证码
```http
POST /api/auth/verify-code
Content-Type: application/json

{
    "email": "user@example.com",
    "code": "123456",
    "code_type": "register"
}
```

### 带验证码注册
```http
POST /api/auth/register-with-verification
Content-Type: application/json

{
    "username": "testuser",
    "email": "user@example.com",
    "password": "password123",
    "full_name": "测试用户",
    "verification_code": "123456"
}
```

## 数据库表结构

### email_verifications 表
```sql
CREATE TABLE email_verifications (
    id INTEGER PRIMARY KEY,
    email VARCHAR(120) NOT NULL,
    verification_code VARCHAR(10) NOT NULL,
    code_type VARCHAR(20) DEFAULT 'register',
    is_used BOOLEAN DEFAULT FALSE,
    ip_address VARCHAR(45),
    user_agent VARCHAR(255),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME NOT NULL,
    used_at DATETIME
);
```

## 部署注意事项

### 1. 生产环境配置
- 设置强密码
- 启用HTTPS
- 配置防火墙
- 定期清理过期验证码

### 2. 监控和维护
- 监控邮件发送成功率
- 定期检查验证码使用情况
- 清理过期数据

### 3. 性能优化
- 使用邮件队列（可选）
- 缓存验证码（可选）
- 数据库索引优化

## 故障排除

### 常见问题

1. **邮件发送失败**
   - 检查SMTP配置
   - 验证邮箱密码
   - 检查网络连接

2. **验证码收不到**
   - 检查垃圾邮件文件夹
   - 验证邮箱地址
   - 检查邮件服务器状态

3. **频率限制**
   - 等待冷却时间
   - 检查IP限制
   - 联系管理员

## 开发调试

### 测试模式
设置环境变量：
```bash
MAIL_SUPPRESS_SEND=True  # 不实际发送邮件
```

### 日志查看
```bash
# 查看邮件发送日志
tail -f logs/mail.log

# 查看验证码日志
tail -f logs/verification.log
```

## 系统架构图

```
用户注册流程：
1. 用户输入邮箱 → 2. 发送验证码 → 3. 用户输入验证码 → 4. 验证通过 → 5. 完成注册

邮件发送流程：
1. 生成验证码 → 2. 保存到数据库 → 3. 发送邮件 → 4. 用户接收 → 5. 验证使用

安全机制：
- 频率限制 → 防刷保护
- 过期机制 → 时效控制  
- 一次性使用 → 防重放攻击
- IP限制 → 防恶意请求
```

## 联系支持

如有问题，请联系技术支持团队或查看项目文档。

---

**注意**：请妥善保管邮件服务配置信息，不要将敏感信息提交到版本控制系统。
