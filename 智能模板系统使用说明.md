# 智能模板系统使用说明

## 📖 功能概述

本系统现在支持**智能模板检测**功能,可以自动判断用户上传的Word模板类型,并采用最合适的方式生成和导出教案。

### 🎯 核心优势

1. **自动识别** - 无需用户手动选择,系统自动检测模板类型
2. **双重支持** - 同时支持带标签和不带标签的模板
3. **格式保留** - 标签模式完美保留用户自定义的Word格式
4. **灵活扩展** - 支持60+个教学标签,可轻松添加新标签

---

## 🔄 工作流程

### 模式1: 普通模板（无标签）

```
用户上传模板 → 系统检测(无标签) → 使用VLM视觉识别
    ↓
生成Markdown格式教案
    ↓
导出为Word文档（自动格式化）
```

**适用场景**: 
- 学校提供的标准格式模板
- 复杂的表格布局模板
- 需要AI自动理解模板结构

---

### 模式2: 智能标签模板（推荐）

```
用户上传带{{标签}}的模板 → 系统检测(有标签) → 识别标签列表
    ↓
生成JSON结构化数据（按标签生成内容）
    ↓
直接填充到模板对应位置 → 导出为Word文档（完美保留原格式）
```

**适用场景**:
- 用户想完全自定义Word格式
- 需要精确控制每个字段的位置和样式
- 多次使用同一模板生成不同教案

---

## 🏷️ 如何使用标签模式

### 步骤1: 准备Word模板

1. 打开Word,创建您的教案模板
2. 在需要自动填充内容的位置,插入标签

**标签格式**: `{{标签名}}`

**示例**:

```
课程名称: {{course_name}}
授课教师: {{teacher_name}}
授课班级: {{class_name}}

第 {{lesson_number}} 次课

一、课题
{{lesson_title}}

二、教学目标

【思政育人目标】
{{ideological_goals}}

【知识目标】
{{knowledge_goals}}

【能力目标】
{{ability_goals}}

三、教学重点
{{teaching_focus}}

【解决措施】
{{focus_solutions}}

四、教学难点
{{teaching_difficulty}}

【解决措施】
{{difficulty_solutions}}

五、教学方法
教法: {{teaching_methods}}
学法: {{learning_methods}}

六、教学资源
{{teaching_resources}}

七、教学过程

【课前预习】
教学内容: {{preview_content}}
教师活动: {{preview_teacher}}
学生活动: {{preview_student}}
设计意图: {{preview_intention}}

【新课导入】
教学内容: {{introduction_content}}
教师活动: {{introduction_teacher}}
学生活动: {{introduction_student}}
设计意图: {{introduction_intention}}

【新课讲授】
教学内容: {{teaching_content}}
教师活动: {{teaching_teacher}}
学生活动: {{teaching_student}}
设计意图: {{teaching_intention}}

【实践环节】
教学内容: {{practice_content}}
教师活动: {{practice_teacher}}
学生活动: {{practice_student}}
设计意图: {{practice_intention}}

【课后作业】
教学内容: {{homework_content}}
教师活动: {{homework_teacher}}
学生活动: {{homework_student}}
设计意图: {{homework_intention}}

八、教学反思
{{reflection_effects}}
{{reflection_improvements}}
```

### 步骤2: 上传到系统

1. 启动系统: `python web_main.py`
2. 访问: `http://localhost:5000`
3. 拖入您的模板文件

### 步骤3: 系统自动识别

系统会自动:
- ✅ 检测模板中的所有标签
- ✅ 识别哪些标签是支持的
- ✅ 自动切换到标签模式
- ✅ 在生成时为每个标签生成对应内容

### 步骤4: 生成和导出

1. 输入课程需求（如"生成数据结构课程教案,16课时"）
2. 系统自动:
   - 生成课程大纲
   - 为每个标签生成内容（JSON格式）
   - 将内容填充到模板对应位置
   - 导出完整的Word文档

**结果**: 获得格式完全符合您模板的教案文档!

---

## 📋 支持的标签列表

### 一、基本信息（7个）

| 标签名 | 说明 | 示例内容 |
|--------|------|---------|
| `{{course_name}}` | 课程名称 | 数据结构 |
| `{{teacher_name}}` | 授课教师 | 张老师 |
| `{{class_name}}` | 授课班级 | 计算机2021级1班 |
| `{{lesson_number}}` | 课次 | 1 |
| `{{lesson_title}}` | 课题 | 数据结构概述 |
| `{{teaching_hours}}` | 学时 | 2 |
| `{{chapter_section}}` | 授课章节 | 第一章 |

### 二、教学目标（4个）

| 标签名 | 说明 |
|--------|------|
| `{{ideological_goals}}` | 思政育人目标 |
| `{{knowledge_goals}}` | 知识目标 |
| `{{ability_goals}}` | 能力目标 |
| `{{ideological_elements}}` | 思政元素 |

### 三、教学重难点（4个）

| 标签名 | 说明 |
|--------|------|
| `{{teaching_focus}}` | 教学重点 |
| `{{focus_solutions}}` | 教学重点解决措施 |
| `{{teaching_difficulty}}` | 教学难点 |
| `{{difficulty_solutions}}` | 教学难点解决措施 |

### 四、教学方法（3个）

| 标签名 | 说明 |
|--------|------|
| `{{teaching_methods}}` | 教法 |
| `{{learning_methods}}` | 学法 |
| `{{teaching_resources}}` | 教学资源 |

### 五、教学过程（10个环节 × 4个维度 = 40个标签）

每个教学环节包含4个维度:
- `_content` - 教学内容
- `_teacher` - 教师活动
- `_student` - 学生活动
- `_intention` - 设计意图

#### 1. 课前预习（4个）
- `{{preview_content}}`
- `{{preview_teacher}}`
- `{{preview_student}}`
- `{{preview_intention}}`

#### 2. 自主学习（4个）
- `{{self_learning_content}}`
- `{{self_learning_teacher}}`
- `{{self_learning_student}}`
- `{{self_learning_intention}}`

#### 3. 新课导入（4个）
- `{{introduction_content}}`
- `{{introduction_teacher}}`
- `{{introduction_student}}`
- `{{introduction_intention}}`

#### 4. 预习反馈（4个）
- `{{feedback_content}}`
- `{{feedback_teacher}}`
- `{{feedback_student}}`
- `{{feedback_intention}}`

#### 5. 新课讲授（4个）
- `{{teaching_content}}`
- `{{teaching_teacher}}`
- `{{teaching_student}}`
- `{{teaching_intention}}`

#### 6. 实践环节（4个）
- `{{practice_content}}`
- `{{practice_teacher}}`
- `{{practice_student}}`
- `{{practice_intention}}`

#### 7. 展示环节（4个）
- `{{presentation_content}}`
- `{{presentation_teacher}}`
- `{{presentation_student}}`
- `{{presentation_intention}}`

#### 8. 评价环节（4个）
- `{{evaluation_content}}`
- `{{evaluation_teacher}}`
- `{{evaluation_student}}`
- `{{evaluation_intention}}`

#### 9. 课后作业（4个）
- `{{homework_content}}`
- `{{homework_teacher}}`
- `{{homework_student}}`
- `{{homework_intention}}`

#### 10. 阅读延伸（4个）
- `{{extension_content}}`
- `{{extension_teacher}}`
- `{{extension_student}}`
- `{{extension_intention}}`

### 六、教学反思（2个）

| 标签名 | 说明 |
|--------|------|
| `{{reflection_effects}}` | 目标效果 |
| `{{reflection_improvements}}` | 反思改进 |

---

## 🔧 技术实现

### 关键代码位置

1. **标签检测**: `utils/template_filler.py` - `WordTemplateFiller.check_template_tags()`
2. **模板解析**: `core/agent.py` - `extract_template_keywords()`
3. **标签模式生成**: `core/agent.py` - `generate_lesson_plan_for_tags()`
4. **普通模式生成**: `core/agent.py` - `generate_university_lesson_plan()`
5. **智能导出**: `utils/lesson_exporter.py` - `LessonExporter.smart_export()`

### 判断逻辑

```python
# 1. 检测模板
tag_info = filler.check_template_tags(template_path)

# 2. 判断模式
if tag_info.get('has_tags') and tag_info.get('recognized_tags'):
    template_mode = "tags"  # 标签模式
else:
    template_mode = "text"  # 普通模式

# 3. 选择生成方法
if template_mode == "tags":
    lesson_data = await agent.generate_lesson_plan_for_tags(lesson_info, detected_tags)
else:
    lesson_text = await agent.generate_university_lesson_plan(lesson_info, template_structure)

# 4. 智能导出
file_path, success = exporter.smart_export(
    lesson_plans=lesson_plans,
    template_mode=template_mode,
    template_path=original_template_path
)
```

---

## 🎓 最佳实践

### 1. 推荐使用标签模式的场景

✅ **适合标签模式**:
- 需要精确控制格式（字体、颜色、间距等）
- 模板会重复使用多次
- 教案结构相对固定
- 想要快速批量生成

❌ **不适合标签模式**:
- 模板结构过于复杂（多层嵌套表格）
- 模板每次都会变化
- 对格式没有特殊要求

### 2. 标签命名建议

- 使用小写英文和下划线
- 见名知意（如 `teaching_focus` 而非 `tf`）
- 与系统支持的标签保持一致（避免拼写错误）

### 3. 模板设计技巧

- 在插入标签前先完成整体布局
- 标签位置预留足够空间（内容长度可能超出预期）
- 测试时先生成1-2个教案查看效果
- 可以使用表格来组织标签,保持整齐

---

## ❓ 常见问题

### Q1: 系统如何知道我的模板有没有标签?

**A**: 系统在解析模板时会自动检测所有 `{{}}` 包裹的内容,如果检测到支持的标签,自动切换到标签模式。

### Q2: 我可以只使用部分标签吗?

**A**: 可以!系统只会为检测到的标签生成内容,未使用的标签不会影响生成过程。

### Q3: 如果标签拼写错误会怎样?

**A**: 系统会在检测时报告"未识别的标签",但不会中断流程。拼写错误的标签将保持原样,不会被填充内容。

### Q4: 标签模式生成的内容会更准确吗?

**A**: 两种模式的内容质量相同,区别在于:
- **标签模式**: 格式由用户模板决定,100%保留原格式
- **普通模式**: 格式由系统自动生成,可能与原模板略有差异

### Q5: 我可以在一个模板中混用标签和普通文字吗?

**A**: 完全可以!标签只是占位符,模板的其他内容（文字、图片、表格等）都会原封不动地保留。

---

## 📞 技术支持

如有问题或建议,请参考:

- 📖 完整标签列表: `完整标签列表.md`
- 🎯 快速参考: `标签系统使用说明.txt`
- 🔬 测试脚本: `python test_smart_template.py`
- 📘 高级功能文档: `高级功能_智能模板填充.md`

---

## 🎉 更新日志

**v2.0** (当前版本)
- ✅ 新增智能模板检测功能
- ✅ 支持标签模式和普通模式自动切换
- ✅ 扩展到60+个教学标签
- ✅ 优化导出流程,支持模板填充
- ✅ 添加详细的使用文档和测试工具

**v1.0**
- 基础教案生成功能
- VLM视觉模板识别
- Markdown格式导出

---

**享受智能教案生成的便利吧!** 🎓✨

