# 用户认证系统使用说明

## 系统概述

本系统为EduAgent智教创想添加了完整的用户认证功能，包括用户注册、登录、会话管理、权限控制等。

## 功能特性

### 🔐 用户认证功能
- **用户注册**: 支持用户名、邮箱注册，密码强度验证
- **用户登录**: 支持用户名/邮箱登录，记住我功能
- **会话管理**: JWT令牌认证，多设备会话管理
- **密码安全**: 密码哈希存储，强度验证
- **用户资料**: 个人资料管理，头像支持

### 🛡️ 安全特性
- **密码强度验证**: 要求包含大小写字母、数字、特殊字符
- **会话超时**: 24小时自动过期
- **多设备登录**: 支持同时多个设备登录
- **权限控制**: 基于角色的访问控制
- **CSRF保护**: 表单安全验证

### 🎨 用户界面
- **响应式设计**: 适配各种设备尺寸
- **现代化UI**: 美观的登录注册界面
- **实时验证**: 表单字段实时验证
- **用户友好**: 清晰的错误提示和成功反馈

## 技术架构

### 后端技术栈
- **Flask**: Web框架
- **SQLAlchemy**: ORM数据库操作
- **Flask-Login**: 用户会话管理
- **JWT**: 令牌认证
- **bcrypt**: 密码哈希

### 前端技术栈
- **原生JavaScript**: 无框架依赖
- **CSS3**: 现代化样式
- **Fetch API**: 异步请求处理

### 数据库设计
- **users**: 用户基本信息表
- **user_sessions**: 用户会话表
- **user_templates**: 用户模板表
- **user_lesson_plans**: 用户教案表

## 安装和配置

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 数据库配置
系统使用SQLite数据库，首次运行会自动创建数据库表。

### 3. 启动应用
```bash
python flask_main.py
```

## API接口文档

### 认证接口

#### 用户注册
```http
POST /api/auth/register
Content-Type: application/json

{
    "username": "用户名",
    "email": "邮箱",
    "password": "密码",
    "full_name": "真实姓名（可选）"
}
```

#### 用户登录
```http
POST /api/auth/login
Content-Type: application/json

{
    "username_or_email": "用户名或邮箱",
    "password": "密码",
    "remember_me": true/false
}
```

#### 用户登出
```http
POST /api/auth/logout
Authorization: Bearer <token>
```

#### 获取用户资料
```http
GET /api/auth/profile
Authorization: Bearer <token>
```

#### 更新用户资料
```http
PUT /api/auth/profile
Authorization: Bearer <token>
Content-Type: application/json

{
    "full_name": "新姓名",
    "avatar_url": "头像URL"
}
```

#### 修改密码
```http
POST /api/auth/change-password
Authorization: Bearer <token>
Content-Type: application/json

{
    "old_password": "原密码",
    "new_password": "新密码"
}
```

#### 验证令牌
```http
GET /api/auth/verify
Authorization: Bearer <token>
```

### 辅助接口

#### 检查用户名可用性
```http
POST /api/auth/check-username
Content-Type: application/json

{
    "username": "用户名"
}
```

#### 检查邮箱可用性
```http
POST /api/auth/check-email
Content-Type: application/json

{
    "email": "邮箱"
}
```

#### 验证密码强度
```http
POST /api/auth/validate-password
Content-Type: application/json

{
    "password": "密码"
}
```

## 前端使用

### 页面路由
- `/login` - 登录页面
- `/register` - 注册页面
- `/` - 主页（带用户认证状态）

### JavaScript API

#### 用户认证方法
```javascript
// 用户登录
const result = await app.login(username, password, rememberMe);

// 用户注册
const result = await app.register(userData);

// 用户登出
await app.logout();

// 获取认证头
const headers = app.getAuthHeaders();
```

#### 全局函数
```javascript
// 切换用户菜单
toggleUserMenu();

// 显示用户资料
showUserProfile();

// 显示用户设置
showUserSettings();

// 用户登出
logout();
```

## 安全建议

### 生产环境配置
1. **修改SECRET_KEY**: 使用强随机密钥
2. **使用HTTPS**: 确保传输安全
3. **数据库安全**: 使用生产级数据库
4. **日志记录**: 启用访问日志
5. **速率限制**: 防止暴力破解

### 密码策略
- 最少8位字符
- 包含大写字母
- 包含小写字母
- 包含数字
- 包含特殊字符

## 数据库表结构

### users表
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(80) UNIQUE NOT NULL,
    email VARCHAR(120) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    avatar_url VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    is_admin BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME
);
```

### user_sessions表
```sql
CREATE TABLE user_sessions (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    session_token VARCHAR(255) UNIQUE NOT NULL,
    ip_address VARCHAR(45),
    user_agent VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users (id)
);
```

## 错误处理

### 常见错误码
- `AUTH_REQUIRED`: 需要登录
- `TOKEN_INVALID`: 令牌无效
- `ACCOUNT_DISABLED`: 账户被禁用
- `ADMIN_REQUIRED`: 需要管理员权限
- `RATE_LIMIT_EXCEEDED`: 请求过于频繁

### 错误处理示例
```javascript
try {
    const result = await app.login(username, password);
    if (!result.success) {
        console.error('登录失败:', result.message);
    }
} catch (error) {
    console.error('网络错误:', error);
}
```

## 扩展功能

### 可扩展的功能
1. **邮箱验证**: 注册时发送验证邮件
2. **双因素认证**: 2FA安全验证
3. **社交登录**: 第三方登录集成
4. **用户角色**: 更细粒度的权限控制
6. **审计日志**: 用户操作记录

### 集成建议
1. **Redis缓存**: 会话缓存优化
2. **邮件服务**: 通知和验证
3. **文件存储**: 头像和文件管理
4. **监控系统**: 性能和安全监控

## 故障排除

### 常见问题
1. **数据库连接失败**: 检查数据库配置
2. **令牌验证失败**: 检查SECRET_KEY配置
3. **CORS错误**: 检查跨域配置
4. **密码验证失败**: 检查密码强度要求

### 调试方法
1. 查看浏览器控制台错误
2. 检查网络请求状态
3. 查看服务器日志
4. 验证数据库连接

## 更新日志

### v1.0.0 (2025-01-XX)
- ✅ 基础用户认证功能
- ✅ 注册登录界面
- ✅ 会话管理
- ✅ 密码安全
- ✅ 用户界面集成

---

**注意**: 本系统为演示版本，生产环境使用前请进行充分的安全测试和配置优化。
